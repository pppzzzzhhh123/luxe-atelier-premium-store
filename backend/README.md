# ç’çˆå¥³è£… - åç«¯ API

åŸºäº Node.js + Express + TypeScript + Supabase æ„å»ºçš„ç”µå•†åç«¯ç³»ç»Ÿã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ supabase.ts          # Supabase æ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.ts              # JWT è®¤è¯ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ error.ts             # å…¨å±€é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ notFound.ts          # 404 å¤„ç†
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.ts              # è®¤è¯è·¯ç”±ï¼ˆæ³¨å†Œ/ç™»å½•ï¼‰
â”‚   â”‚   â”œâ”€â”€ products.ts          # å•†å“è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ orders.ts            # è®¢å•è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ cart.ts              # è´­ç‰©è½¦è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ address.ts           # æ”¶è´§åœ°å€è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ coupons.ts           # ä¼˜æƒ åˆ¸è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ points.ts            # ç§¯åˆ†è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ invite.ts            # é‚€è¯·è¿”ç°è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ wallet.ts            # é’±åŒ…è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ posts.ts             # ç¤¾åŒºå¸–å­è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ reviews.ts           # å•†å“è¯„ä»·è·¯ç”±
â”‚   â”‚   â””â”€â”€ users.ts             # ç”¨æˆ·ä¿¡æ¯è·¯ç”±
â”‚   â””â”€â”€ index.ts                 # åº”ç”¨å…¥å£
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 001_initial_schema.sql  # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ package.json                 # ä¾èµ–é…ç½®
â”œâ”€â”€ tsconfig.json                # TypeScript é…ç½®
â””â”€â”€ README.md                    # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™é…ç½®ï¼š

```env
# Supabase é…ç½®
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-key

# JWT å¯†é’¥
JWT_SECRET=your-super-secret-jwt-key

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# å‰ç«¯åœ°å€ï¼ˆCORSï¼‰
FRONTEND_URL=http://localhost:5173
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

åœ¨ Supabase æ§åˆ¶å°æ‰§è¡Œ `supabase/migrations/001_initial_schema.sql`

### 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm run build
npm start
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3000` å¯åŠ¨

## ğŸ“š API æ–‡æ¡£

### è®¤è¯ç›¸å…³ `/api/auth`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| POST | `/register` | ç”¨æˆ·æ³¨å†Œ | âŒ |
| POST | `/login` | ç”¨æˆ·ç™»å½• | âŒ |
| POST | `/send-code` | å‘é€éªŒè¯ç  | âŒ |
| POST | `/validate-invite` | éªŒè¯é‚€è¯·ç  | âŒ |

### å•†å“ç›¸å…³ `/api/products`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–å•†å“åˆ—è¡¨ | âŒ |
| GET | `/:id` | è·å–å•†å“è¯¦æƒ… | âŒ |
| POST | `/` | åˆ›å»ºå•†å“ | âœ… |
| PUT | `/:id` | æ›´æ–°å•†å“ | âœ… |
| DELETE | `/:id` | åˆ é™¤å•†å“ | âœ… |

### è´­ç‰©è½¦ç›¸å…³ `/api/cart`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–è´­ç‰©è½¦ | âœ… |
| POST | `/` | æ·»åŠ å•†å“ | âœ… |
| PUT | `/:id` | æ›´æ–°æ•°é‡ | âœ… |
| DELETE | `/:id` | åˆ é™¤å•†å“ | âœ… |
| DELETE | `/` | æ¸…ç©ºè´­ç‰©è½¦ | âœ… |

### è®¢å•ç›¸å…³ `/api/orders`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–è®¢å•åˆ—è¡¨ | âœ… |
| GET | `/:id` | è·å–è®¢å•è¯¦æƒ… | âœ… |
| POST | `/` | åˆ›å»ºè®¢å• | âœ… |
| POST | `/:id/pay` | æ”¯ä»˜è®¢å• | âœ… |
| POST | `/:id/cancel` | å–æ¶ˆè®¢å• | âœ… |
| POST | `/:id/confirm` | ç¡®è®¤æ”¶è´§ | âœ… |

### æ”¶è´§åœ°å€ `/api/addresses`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–åœ°å€åˆ—è¡¨ | âœ… |
| GET | `/:id` | è·å–åœ°å€è¯¦æƒ… | âœ… |
| POST | `/` | æ·»åŠ åœ°å€ | âœ… |
| PUT | `/:id` | æ›´æ–°åœ°å€ | âœ… |
| DELETE | `/:id` | åˆ é™¤åœ°å€ | âœ… |
| POST | `/:id/default` | è®¾ç½®é»˜è®¤åœ°å€ | âœ… |

### ä¼˜æƒ åˆ¸ç›¸å…³ `/api/coupons`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ | âœ… |
| GET | `/available` | è·å–å¯ç”¨ä¼˜æƒ åˆ¸ | âœ… |
| POST | `/receive` | é¢†å–ä¼˜æƒ åˆ¸ | âœ… |

### ç§¯åˆ†ç›¸å…³ `/api/points`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–ç§¯åˆ†è®°å½• | âœ… |
| POST | `/checkin` | æ¯æ—¥ç­¾åˆ° | âœ… |
| GET | `/checkin/status` | è·å–ç­¾åˆ°çŠ¶æ€ | âœ… |

### é‚€è¯·è¿”ç° `/api/invite`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/stats` | è·å–é‚€è¯·ç»Ÿè®¡ | âœ… |
| GET | `/records` | è·å–é‚€è¯·è®°å½• | âœ… |
| GET | `/rewards` | è·å–è¿”ç°è®°å½• | âœ… |
| POST | `/withdraw` | æç°åˆ°ä½™é¢ | âœ… |

### é’±åŒ…ç›¸å…³ `/api/wallet`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–é’±åŒ…ä¿¡æ¯ | âœ… |
| POST | `/recharge` | å……å€¼ä½™é¢ | âœ… |

### ç¤¾åŒºå¸–å­ `/api/posts`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/` | è·å–å¸–å­åˆ—è¡¨ | âŒ |
| GET | `/:id` | è·å–å¸–å­è¯¦æƒ… | âŒ |
| POST | `/` | å‘å¸ƒå¸–å­ | âœ… |
| POST | `/:id/like` | ç‚¹èµå¸–å­ | âœ… |
| POST | `/:id/comment` | è¯„è®ºå¸–å­ | âœ… |
| DELETE | `/:id` | åˆ é™¤å¸–å­ | âœ… |

### å•†å“è¯„ä»· `/api/reviews`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/product/:productId` | è·å–å•†å“è¯„ä»· | âŒ |
| POST | `/` | å‘å¸ƒè¯„ä»· | âœ… |
| GET | `/my` | è·å–æˆ‘çš„è¯„ä»· | âœ… |

### ç”¨æˆ·ä¿¡æ¯ `/api/users`

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| GET | `/profile` | è·å–ä¸ªäººä¿¡æ¯ | âœ… |
| PUT | `/profile` | æ›´æ–°ä¸ªäººä¿¡æ¯ | âœ… |
| GET | `/stats` | è·å–ç”¨æˆ·ç»Ÿè®¡ | âœ… |

## ğŸ” è®¤è¯è¯´æ˜

éœ€è¦è®¤è¯çš„æ¥å£éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ JWT Tokenï¼š

```
Authorization: Bearer <token>
```

## ğŸ“¦ ä¾èµ–è¯´æ˜

### æ ¸å¿ƒä¾èµ–

- `express` - Web æ¡†æ¶
- `typescript` - TypeScript æ”¯æŒ
- `@supabase/supabase-js` - Supabase å®¢æˆ·ç«¯
- `jsonwebtoken` - JWT è®¤è¯
- `bcryptjs` - å¯†ç åŠ å¯†
- `cors` - è·¨åŸŸæ”¯æŒ
- `helmet` - å®‰å…¨å¤´éƒ¨
- `morgan` - æ—¥å¿—è®°å½•
- `dotenv` - ç¯å¢ƒå˜é‡

### å¼€å‘ä¾èµ–

- `@types/*` - TypeScript ç±»å‹å®šä¹‰
- `ts-node` - TypeScript è¿è¡Œæ—¶
- `nodemon` - è‡ªåŠ¨é‡å¯
- `tsx` - TypeScript æ‰§è¡Œå™¨

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

å…± 20 å¼ è¡¨ï¼š

1. **users** - ç”¨æˆ·è¡¨
2. **categories** - å•†å“åˆ†ç±»è¡¨
3. **products** - å•†å“è¡¨
4. **addresses** - æ”¶è´§åœ°å€è¡¨
5. **coupons** - ä¼˜æƒ åˆ¸æ¨¡æ¿è¡¨
6. **orders** - è®¢å•è¡¨
7. **order_items** - è®¢å•å•†å“è¡¨
8. **cart_items** - è´­ç‰©è½¦è¡¨
9. **user_coupons** - ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨
10. **points_records** - ç§¯åˆ†è®°å½•è¡¨
11. **invite_records** - é‚€è¯·è®°å½•è¡¨
12. **reward_records** - è¿”ç°è®°å½•è¡¨
13. **wallet_transactions** - é’±åŒ…äº¤æ˜“è®°å½•è¡¨
14. **posts** - ç¤¾åŒºå¸–å­è¡¨
15. **post_comments** - å¸–å­è¯„è®ºè¡¨
16. **reviews** - å•†å“è¯„ä»·è¡¨
17. **refunds** - é€€æ¬¾/å”®åè¡¨
18. **checkin_records** - ç­¾åˆ°è®°å½•è¡¨
19. **memberships** - ä¼šå‘˜è®°å½•è¡¨
20. **system_configs** - ç³»ç»Ÿé…ç½®è¡¨

è¯¦ç»†è¡¨ç»“æ„è¯·æŸ¥çœ‹ `supabase/migrations/001_initial_schema.sql`

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ·ç³»ç»Ÿ
- âœ… æ‰‹æœºå·æ³¨å†Œ/ç™»å½•
- âœ… JWT è®¤è¯
- âœ… ä¸ªäººä¿¡æ¯ç®¡ç†
- âœ… é‚€è¯·ç ç³»ç»Ÿ

### 2. å•†å“ç³»ç»Ÿ
- âœ… å•†å“åˆ—è¡¨/è¯¦æƒ…
- âœ… åˆ†ç±»ç­›é€‰
- âœ… æœç´¢åŠŸèƒ½
- âœ… ä»·æ ¼æ’åº

### 3. è´­ç‰©è½¦
- âœ… æ·»åŠ /åˆ é™¤å•†å“
- âœ… ä¿®æ”¹æ•°é‡
- âœ… åº“å­˜æ£€æŸ¥

### 4. è®¢å•ç³»ç»Ÿ
- âœ… åˆ›å»ºè®¢å•
- âœ… æ”¯ä»˜è®¢å•
- âœ… è®¢å•çŠ¶æ€ç®¡ç†
- âœ… å–æ¶ˆ/ç¡®è®¤æ”¶è´§

### 5. ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- âœ… ä¼˜æƒ åˆ¸é¢†å–
- âœ… è®¢å•ä½¿ç”¨
- âœ… è¿‡æœŸç®¡ç†

### 6. ç§¯åˆ†ç³»ç»Ÿ
- âœ… è®¢å•è·å¾—ç§¯åˆ†
- âœ… æ¯æ—¥ç­¾åˆ°
- âœ… è¿ç»­ç­¾åˆ°å¥–åŠ±

### 7. é‚€è¯·è¿”ç°
- âœ… é‚€è¯·ç ç”Ÿæˆ
- âœ… æ³¨å†Œèµ åˆ¸
- âœ… é¦–å•è¿”ç°ï¼ˆ5%ï¼‰
- âœ… æç°åˆ°ä½™é¢

### 8. é’±åŒ…ç³»ç»Ÿ
- âœ… ä½™é¢ç®¡ç†
- âœ… äº¤æ˜“è®°å½•
- âœ… å……å€¼åŠŸèƒ½

### 9. ç¤¾åŒºåŠŸèƒ½
- âœ… å‘å¸ƒå¸–å­
- âœ… ç‚¹èµè¯„è®º
- âœ… å›¾ç‰‡ä¸Šä¼ 

### 10. è¯„ä»·ç³»ç»Ÿ
- âœ… å•†å“è¯„ä»·
- âœ… è¯„ä»·æ™’å›¾
- âœ… åŒ¿åè¯„ä»·

## ğŸ”§ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°è·¯ç”±

1. åœ¨ `src/routes/` åˆ›å»ºæ–°æ–‡ä»¶
2. åœ¨ `src/index.ts` ä¸­å¯¼å…¥å¹¶æ³¨å†Œè·¯ç”±

```typescript
// src/routes/example.ts
import { Router } from 'express';
const router = Router();

router.get('/', (req, res) => {
  res.json({ message: 'Hello' });
});

export default router;

// src/index.ts
import exampleRoutes from './routes/example';
app.use('/api/example', exampleRoutes);
```

### æ•°æ®åº“æŸ¥è¯¢

ä½¿ç”¨ Supabase å®¢æˆ·ç«¯ï¼š

```typescript
import { supabase } from '../config/supabase';

// æŸ¥è¯¢
const { data, error } = await supabase
  .from('users')
  .select('*')
  .eq('id', userId)
  .single();

// æ’å…¥
const { data, error } = await supabase
  .from('users')
  .insert({ name: 'John' })
  .select()
  .single();

// æ›´æ–°
const { data, error } = await supabase
  .from('users')
  .update({ name: 'Jane' })
  .eq('id', userId);

// åˆ é™¤
const { error } = await supabase
  .from('users')
  .delete()
  .eq('id', userId);
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**ï¼šç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹ `JWT_SECRET`
2. **CORS é…ç½®**ï¼šæ ¹æ®å‰ç«¯åŸŸåé…ç½® CORS
3. **æ•°æ®åº“ RLS**ï¼šSupabase å·²é…ç½® Row Level Security
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰è·¯ç”±éƒ½æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†
5. **æ—¥å¿—è®°å½•**ï¼šå¼€å‘ç¯å¢ƒè‡ªåŠ¨è®°å½•è¯·æ±‚æ—¥å¿—

## ğŸš€ éƒ¨ç½²

### Vercel éƒ¨ç½²

```bash
npm install -g vercel
vercel --prod
```

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ æ‰€æœ‰ç¯å¢ƒå˜é‡ã€‚

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ‘¨â€ğŸ’» ä½œè€…

ç’çˆå¥³è£…å¼€å‘å›¢é˜Ÿ
