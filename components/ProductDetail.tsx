import React, { useState, useEffect } from 'react';
import { Product, NavigateHandler } from '../types';

interface ProductDetailProps {
  product: Product | null;
  onBack: () => void;
  onNavigate: NavigateHandler;
  onAddToCart?: (product: Product, spec: string, quantity: number) => void;
  cartCount?: number;
  showFeedback?: (message: string) => void;
}

const ProductDetail: React.FC<ProductDetailProps> = ({ product, onBack, onNavigate, onAddToCart, cartCount = 0, showFeedback }) => {
  const [selectedSize, setSelectedSize] = useState('S');
  const [selectedColor, setSelectedColor] = useState('常规色');
  const [mainImage, setMainImage] = useState('');
  const [isSelectionOpen, setIsSelectionOpen] = useState(false);
  const [quantity, setQuantity] = useState(1);
  const [actionType, setActionType] = useState<'cart' | 'buy'>('cart');
  const [showComments, setShowComments] = useState(false);
  const [showPurchaseRecords, setShowPurchaseRecords] = useState(false);
  const [expandedComments, setExpandedComments] = useState<Set<number>>(new Set());
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [showCustomerService, setShowCustomerService] = useState(false);
  const [scrollOffset, setScrollOffset] = useState(0);

  const salesData = { sold: 1286, stock: 234, totalStock: 1520 };

  const comments = [
    { id: 1, user: '张**', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop', rating: 5, content: '质量非常好，面料很舒服，版型也很好看！', images: [product?.img || ''], time: '2024-01-15', spec: '常规色 / M' },
    { id: 2, user: '李**', avatar: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=100&h=100&fit=crop', rating: 5, content: '超级喜欢，已经回购第二件了，强烈推荐！', images: [], time: '2024-01-14', spec: '经典黑 / S' },
  ];

  const purchaseRecords = [
    { user: '王**', time: '5分钟前', spec: '常规色 / M' },
    { user: '刘**', time: '12分钟前', spec: '经典黑 / L' },
    { user: '陈**', time: '25分钟前', spec: '米咖色 / S' },
    { user: '赵**', time: '1小时前', spec: '常规色 / M' },
    { user: '孙**', time: '2小时前', spec: '经典黑 / M' },
  ];

  const recommendedProducts = [
    { id: 101, title: '羊绒混纺大衣', price: 2899, originalPrice: 3999, img: 'https://images.unsplash.com/photo-1591047139829-d91aecb6caea?auto=format&fit=crop&w=400&q=80' },
    { id: 102, title: '真丝衬衫', price: 1299, originalPrice: 1899, img: 'https://images.unsplash.com/photo-1624206112918-f140f087f9b5?auto=format&fit=crop&w=400&q=80' },
    { id: 103, title: '羊毛针织开衫', price: 1599, originalPrice: 2299, img: 'https://images.unsplash.com/photo-1620799140408-edc6dcb6d633?auto=format&fit=crop&w=400&q=80' },
    { id: 104, title: '高腰阔腿裤', price: 899, originalPrice: 1299, img: 'https://images.unsplash.com/photo-1594633313593-bab3825d0caf?auto=format&fit=crop&w=400&q=80' },
  ];

  useEffect(() => { if (product && product.img) setMainImage(product.img); }, [product]);
  useEffect(() => { const interval = setInterval(() => { setScrollOffset(prev => (prev + 1) % purchaseRecords.length); }, 3000); return () => clearInterval(interval); }, []);

  if (!product) return (<div className="min-h-screen flex flex-col items-center justify-center p-6 bg-white"><span className="material-symbols-outlined text-gray-200 text-6xl mb-4">inventory_2</span><p className="text-gray-400 text-sm">未找到商品信息</p><button onClick={onBack} className="mt-6 px-8 py-2 border border-black text-xs font-bold uppercase tracking-widest">返回</button></div>);

  const thumbs = [product.img, "https://images.unsplash.com/photo-1539109136881-3be0616acf4b?auto=format&fit=crop&w=400&q=80", "https://images.unsplash.com/photo-1434389677669-e08b4cac3105?auto=format&fit=crop&w=400&q=80", "https://images.unsplash.com/photo-1554412930-c74f63719b16?auto=format&fit=crop&w=400&q=80"];

  const handleOpenSelection = (type: 'cart' | 'buy') => { setActionType(type); setIsSelectionOpen(true); };
  const handleConfirmAction = () => { if (!product) return; const spec = `${selectedColor}, ${selectedSize}`; if (actionType === 'cart') { if (onAddToCart) onAddToCart(product, spec, quantity); setIsSelectionOpen(false); } else { onNavigate('checkout', { ...product, spec, count: quantity }); } };
  const toggleCommentExpand = (commentId: number) => { setExpandedComments(prev => { const newSet = new Set(prev); if (newSet.has(commentId)) newSet.delete(commentId); else newSet.add(commentId); return newSet; }); };

  return (<div className="pb-24 bg-white min-h-screen"><header className="fixed top-0 left-1/2 -translate-x-1/2 w-full z-50 flex items-center justify-between px-4 py-4 max-w-[480px] pointer-events-none"><button onClick={onBack} className="w-10 h-10 flex items-center justify-center rounded-full bg-white/60 backdrop-blur-md pointer-events-auto shadow-sm active:scale-90 transition-transform"><span className="material-symbols-outlined">arrow_back</span></button><div className="flex gap-2"><button className="w-10 h-10 flex items-center justify-center rounded-full bg-white/60 backdrop-blur-md pointer-events-auto shadow-sm active:scale-90 transition-transform"><span className="material-symbols-outlined">favorite</span></button></div></header><main><section className="relative w-full"><div className="h-[60vh] w-full overflow-hidden"><img alt="Product" className="w-full h-full object-cover transition-opacity duration-500" src={mainImage || product.img} /></div><div className="flex gap-2 px-4 py-3 overflow-x-auto no-scrollbar bg-white">{thumbs.map((img, idx) => (<div key={idx} onClick={() => setMainImage(img)} className={`w-14 h-14 flex-shrink-0 cursor-pointer border transition-all ${mainImage === img ? 'border-black' : 'border-gray-100'}`}><img className="w-full h-full object-cover" src={img} alt={`thumb-${idx}`} /></div>))}</div></section><section className="px-5 pt-4 pb-6"><div className="flex items-baseline gap-2 mb-1"><span className="text-2xl font-semibold font-serif">¥{product.price.toFixed(2)}</span>{product.originalPrice && (<span className="text-xs text-gray-300 line-through">¥{product.originalPrice.toFixed(2)}</span>)}</div><h1 className="mt-4 font-serif text-xl font-medium leading-tight text-slate-900">{product.title}</h1><p className="text-xs text-slate-400 mt-1 uppercase tracking-widest font-sans">Premium Minimalist Collection</p><div className="mt-4 flex items-center gap-4 text-xs"><div className="flex items-center gap-1"><span className="text-gray-400">已售</span><span className="font-bold text-gray-700">{salesData.sold}</span></div><div className="flex items-center gap-1"><span className="text-gray-400">剩余</span><span className="font-bold text-orange-500">{salesData.stock}</span></div><div className="flex-1"><div className="h-1.5 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-orange-400 to-red-500 rounded-full transition-all" style={{ width: `${(salesData.sold / salesData.totalStock) * 100}%` }}></div></div></div></div><div className="mt-8 flex gap-2"><span className="text-[10px] px-2 py-1 bg-slate-50 text-slate-500 border border-slate-100">顺丰包邮</span><span className="text-[10px] px-2 py-1 bg-slate-50 text-slate-500 border border-slate-100">7天无理由退换</span></div></section><div className="h-2 bg-slate-50"></div><section className="px-5 py-4"><div className="flex items-center justify-between mb-3"><h4 className="text-sm font-bold">用户评价 ({comments.length})</h4><button onClick={() => setShowComments(true)} className="text-xs text-gray-400 flex items-center gap-1 active:opacity-60">查看全部<span className="material-symbols-outlined text-sm">chevron_right</span></button></div>{comments.slice(0, 2).map(comment => { const isExpanded = expandedComments.has(comment.id); const shouldTruncate = comment.content.length > 60; const displayContent = isExpanded || !shouldTruncate ? comment.content : comment.content.slice(0, 60) + '...'; return (<div key={comment.id} className="mb-3 pb-3 border-b border-gray-50 last:border-0"><div className="flex items-center gap-2 mb-2"><img src={comment.avatar} alt={comment.user} className="w-7 h-7 rounded-full object-cover" /><div className="flex-1"><div className="flex items-center gap-2"><p className="text-xs font-medium">{comment.user}</p><div className="flex items-center gap-0.5">{[...Array(comment.rating)].map((_, i) => (<span key={i} className="material-symbols-outlined text-yellow-400 text-[10px]" style={{ fontVariationSettings: "'FILL' 1" }}>star</span>))}</div></div><p className="text-[10px] text-gray-400 mt-0.5">{comment.spec}</p></div><span className="text-[10px] text-gray-400">{comment.time}</span></div><p className="text-xs text-gray-700 leading-relaxed">{displayContent}{shouldTruncate && (<button onClick={() => toggleCommentExpand(comment.id)} className="text-primary text-xs ml-1 active:opacity-60">{isExpanded ? '收起' : '展开'}</button>)}</p></div>); })}</section><div className="h-2 bg-slate-50"></div><section className="px-5 py-6"><div className="flex items-center justify-between mb-4"><h4 className="text-sm font-bold">购买记录</h4><button onClick={() => setShowPurchaseRecords(true)} className="text-xs text-gray-400 flex items-center gap-1 active:opacity-60">查看更多<span className="material-symbols-outlined text-sm">chevron_right</span></button></div><div className="relative h-[120px] overflow-hidden bg-gradient-to-b from-transparent via-gray-50/50 to-transparent rounded-xl"><div className="absolute w-full transition-transform duration-700 ease-in-out" style={{ transform: `translateY(-${scrollOffset * 40}px)` }}>{[...purchaseRecords, ...purchaseRecords].map((record, idx) => (<div key={idx} className="flex items-center justify-between text-xs py-2 px-3 animate-in fade-in slide-in-from-bottom-2" style={{ animationDelay: `${(idx % purchaseRecords.length) * 100}ms`, height: '40px' }}><div className="flex items-center gap-2"><div className="w-6 h-6 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center"><span className="material-symbols-outlined text-sm text-blue-600">person</span></div><span className="text-gray-700 font-medium">{record.user}</span><span className="text-gray-400">购买了</span><span className="text-gray-600 font-medium">{record.spec}</span></div><span className="text-gray-400 text-[10px]">{record.time}</span></div>))}</div></div></section><div className="h-2 bg-slate-50"></div><section className="px-5 py-6"><div className="flex items-center justify-between group cursor-pointer" onClick={() => handleOpenSelection('cart')}><span className="text-[12px] text-gray-700 font-bold uppercase tracking-wider">选择: {selectedColor} / {selectedSize} / {quantity}件</span><span className="material-symbols-outlined text-slate-300 group-hover:text-black transition-colors">chevron_right</span></div></section><div className="h-2 bg-slate-50"></div><section className="px-5 py-6"><h4 className="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-4">商品介绍</h4><div className="space-y-4 text-xs text-slate-500 leading-relaxed"><p>这款单品选用意大利进口优质羊绒面料，触感如云朵般细腻柔软。廓形剪裁融合了现代极简主义，不论是日常通勤还是周末闲暇，都能轻松展现优雅姿态。</p><img src={thumbs[1]} className="w-full rounded-xl" alt="detail-1" /><p>细节之处彰显匠心。每一处针脚都经过严苛把控，确保穿着的舒适度与单品的持久性。</p></div></section><div className="h-2 bg-slate-50"></div><section className="px-5 py-6 pb-8"><div className="flex items-center justify-between mb-4"><h4 className="text-sm font-bold">为你推荐</h4><button onClick={() => onNavigate('productList', { category: '全部系列' })} className="text-xs text-gray-400 flex items-center gap-1 active:opacity-60">查看更多<span className="material-symbols-outlined text-sm">chevron_right</span></button></div><div className="grid grid-cols-2 gap-3">{recommendedProducts.map((item) => (<div key={item.id} onClick={() => { const productData: Product = { id: item.id, title: item.title, price: item.price, originalPrice: item.originalPrice, img: item.img, category: product.category }; window.scrollTo({ top: 0, behavior: 'smooth' }); onNavigate('product', productData); }} className="bg-white rounded-xl overflow-hidden border border-gray-100 active:scale-95 transition-transform cursor-pointer shadow-sm hover:shadow-md"><div className="aspect-[3/4] overflow-hidden bg-gray-50"><img src={item.img} alt={item.title} className="w-full h-full object-cover hover:scale-105 transition-transform duration-500" /></div><div className="p-3"><h5 className="text-xs font-medium text-gray-800 mb-2 line-clamp-2 leading-relaxed">{item.title}</h5><div className="flex items-baseline gap-2"><span className="text-sm font-bold text-black">¥{item.price}</span>{item.originalPrice && (<span className="text-[10px] text-gray-300 line-through">¥{item.originalPrice}</span>)}</div></div></div>))}</div></section></main><footer className="fixed bottom-0 left-1/2 -translate-x-1/2 z-[80] w-full max-w-[480px] bg-white border-t border-slate-100 px-4 py-3 flex items-center gap-2 shadow-lg"><div className="flex gap-2"><button onClick={() => setShowCustomerService(true)} className="flex flex-col items-center gap-1 px-1 active:opacity-60 transition-opacity"><span className="material-symbols-outlined text-xl">chat_bubble</span><span className="text-[8px] font-bold">客服</span></button><button onClick={() => onNavigate('cart')} className="flex flex-col items-center gap-1 px-1 active:opacity-60 transition-opacity relative cursor-pointer"><div className="relative"><span className="material-symbols-outlined text-xl">shopping_bag</span>{cartCount > 0 && (<span className="absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[8px] font-bold min-w-[14px] h-[14px] flex items-center justify-center rounded-full border border-white">{cartCount}</span>)}</div><span className="text-[8px] font-bold">购物袋</span></button></div><div className="flex flex-1 gap-2"><button onClick={() => handleOpenSelection('cart')} className="flex-1 h-11 border border-black text-[11px] font-bold tracking-widest uppercase active:bg-slate-50">加入购物袋</button><button onClick={() => handleOpenSelection('buy')} className="flex-1 h-11 bg-black text-white text-[11px] font-bold tracking-widest uppercase shadow-lg active:bg-slate-800">立即购买</button></div></footer>{isSelectionOpen && (<div className="fixed inset-0 z-[100] flex items-end justify-center"><div className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-in fade-in" onClick={() => setIsSelectionOpen(false)}></div><div className="relative w-full max-w-[480px] bg-white rounded-t-[2.5rem] p-8 pb-10 shadow-2xl animate-in slide-in-from-bottom duration-300"><div className="absolute top-4 right-6"><button onClick={() => setIsSelectionOpen(false)} className="material-symbols-outlined text-slate-300 hover:text-black">close</button></div><div className="flex gap-6 mb-8"><div className="w-24 h-32 bg-slate-50 rounded-xl overflow-hidden shrink-0"><img src={product.img} className="w-full h-full object-cover" alt="selection-thumb" /></div><div className="flex flex-col justify-end"><p className="text-2xl font-serif font-bold text-black mb-1">¥{product.price.toFixed(2)}</p><p className="text-[11px] text-slate-400 mb-2">已选: {selectedColor} / {selectedSize}</p><div className="flex gap-2"><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">顺丰速运</span><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">库存紧张</span></div></div></div><div className="space-y-6"><div><h4 className="text-[11px] font-bold uppercase tracking-[0.2em] text-gray-400 mb-4">尺码 / Size</h4><div className="flex gap-3">{['XS', 'S', 'M', 'L'].map(s => (<button key={s} onClick={() => setSelectedSize(s)} className={`min-w-[50px] h-11 flex items-center justify-center text-xs font-bold border transition-all rounded-lg ${selectedSize === s ? 'bg-black text-white border-black shadow-lg' : 'border-gray-100 text-gray-400'}`}>{s}</button>))}</div></div><div><h4 className="text-[11px] font-bold uppercase tracking-[0.2em] text-gray-400 mb-4">颜色 / Color</h4><div className="flex gap-3">{['常规色', '经典黑', '米咖色'].map(c => (<button key={c} onClick={() => setSelectedColor(c)} className={`px-4 h-11 flex items-center justify-center text-xs font-bold border transition-all rounded-lg ${selectedColor === c ? 'bg-black text-white border-black shadow-lg' : 'border-gray-100 text-gray-400'}`}>{c}</button>))}</div></div><div className="flex items-center justify-between py-4 border-t border-slate-50"><h4 className="text-[11px] font-bold uppercase tracking-[0.2em] text-gray-400">购买数量</h4><div className="flex items-center border border-slate-100 rounded-lg overflow-hidden bg-slate-50"><button onClick={() => setQuantity(Math.max(1, quantity - 1))} className="w-10 h-10 flex items-center justify-center text-slate-400 active:bg-slate-200">－</button><span className="w-12 text-center text-[13px] font-bold font-sans">{quantity}</span><button onClick={() => { const newQuantity = Math.min(99, quantity + 1); if (newQuantity === 99 && showFeedback) showFeedback('单次最多购买99件'); setQuantity(newQuantity); }} className="w-10 h-10 flex items-center justify-center text-slate-400 active:bg-slate-200">＋</button></div></div><button onClick={handleConfirmAction} className="w-full h-14 bg-black text-white text-[13px] font-bold tracking-[0.2em] uppercase rounded-2xl shadow-xl active:scale-95 transition-transform">{actionType === 'cart' ? '确认加入购物袋' : '前往结算'}</button></div></div></div>)}{showComments && (<div className="fixed inset-0 z-[100] flex flex-col bg-white"><header className="sticky top-0 z-50 bg-white border-b border-gray-100"><div className="h-14 flex items-center justify-between px-4"><button onClick={() => setShowComments(false)} className="w-10 h-10 flex items-center justify-center active:scale-90 transition-transform"><span className="material-symbols-outlined text-2xl">arrow_back</span></button><span className="text-[14px] font-bold">用户评价 ({comments.length})</span><div className="w-10"></div></div></header><div className="flex-1 overflow-y-auto px-4 py-4">{comments.map(comment => (<div key={comment.id} className="mb-6 pb-6 border-b border-gray-100 last:border-0"><div className="flex items-center gap-3 mb-3"><img src={comment.avatar} alt={comment.user} className="w-10 h-10 rounded-full object-cover" /><div className="flex-1"><p className="text-sm font-bold">{comment.user}</p><div className="flex items-center gap-1 mt-1">{[...Array(comment.rating)].map((_, i) => (<span key={i} className="material-symbols-outlined text-yellow-400 text-sm" style={{ fontVariationSettings: "'FILL' 1" }}>star</span>))}</div></div><span className="text-xs text-gray-400">{comment.time}</span></div><p className="text-sm text-gray-700 leading-relaxed mb-2">{comment.content}</p><p className="text-xs text-gray-400 mb-2">规格: {comment.spec}</p>{comment.images.length > 0 && (<div className="flex gap-2">{comment.images.map((img, idx) => (<img key={idx} src={img} alt="review" className="w-20 h-20 object-cover rounded-lg" />))}</div>)}</div>))}</div></div>)}{showPurchaseRecords && (<div className="fixed inset-0 z-[100] flex flex-col bg-white"><header className="sticky top-0 z-50 bg-white border-b border-gray-100"><div className="h-14 flex items-center justify-between px-4"><button onClick={() => setShowPurchaseRecords(false)} className="w-10 h-10 flex items-center justify-center active:scale-90 transition-transform"><span className="material-symbols-outlined text-2xl">arrow_back</span></button><span className="text-[14px] font-bold">购买记录</span><div className="w-10"></div></div></header><div className="flex-1 overflow-y-auto px-4 py-4"><div className="space-y-4">{purchaseRecords.map((record, idx) => (<div key={idx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg"><div className="w-10 h-10 bg-white rounded-full flex items-center justify-center"><span className="material-symbols-outlined text-gray-400">person</span></div><div className="flex-1"><p className="text-sm font-medium text-gray-700">{record.user} 购买了此商品</p><p className="text-xs text-gray-400 mt-1">规格: {record.spec}</p></div><span className="text-xs text-gray-400">{record.time}</span></div>))}</div></div></div>)}{selectedImage && (<div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/90" onClick={() => setSelectedImage(null)}><button onClick={() => setSelectedImage(null)} className="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-white/20 backdrop-blur-md text-white active:scale-90 transition-transform"><span className="material-symbols-outlined">close</span></button><img src={selectedImage} alt="preview" className="max-w-[90%] max-h-[90%] object-contain" onClick={(e) => e.stopPropagation()} /></div>)}{showCustomerService && (<div className="fixed inset-0 z-[100] flex items-end justify-center"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setShowCustomerService(false)}></div><div className="relative w-full max-w-[480px] bg-white rounded-t-3xl shadow-2xl animate-in slide-in-from-bottom duration-300 p-6"><button onClick={() => setShowCustomerService(false)} className="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"><span className="material-symbols-outlined text-gray-400">close</span></button><div className="text-center mb-6"><div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg"><span className="material-symbols-outlined text-white text-3xl">support_agent</span></div><h2 className="text-xl font-bold mb-2">联系客服</h2><p className="text-sm text-gray-500">我们随时为您服务</p></div><div className="space-y-3"><button onClick={() => alert('正在连接在线客服...')} className="w-full h-14 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-transform shadow-lg"><span className="material-symbols-outlined text-2xl">chat</span><span className="font-bold">在线客服</span></button><button onClick={() => alert('客服电话：400-888-8888')} className="w-full h-14 bg-white border-2 border-gray-200 rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-transform"><span className="material-symbols-outlined text-2xl text-gray-700">call</span><span className="font-bold text-gray-700">电话客服</span></button><button onClick={() => alert('微信客服：LUXE-Service')} className="w-full h-14 bg-green-500 text-white rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-transform shadow-lg"><span className="text-2xl font-bold">微</span><span className="font-bold">微信客服</span></button></div><div className="mt-6 p-4 bg-gray-50 rounded-xl"><p className="text-xs text-gray-600 text-center leading-relaxed"><span className="font-bold">服务时间：</span>周一至周日 9:00-21:00</p></div></div></div>)}</div>);
};

export default ProductDetail;
